import {_removeDotSegments} from './_removeDotSegments';
import {_isString} from './_isString';
import {url} from './url';
import {merge} from './merge';
export function _prependBase(base, iri) {
      // skip IRI processing
      if (base === null) {
        return iri;
      }
      // already an absolute IRI
      if (iri.indexOf(':') !== -1) {
        return iri;
      }

      // parse base if it is a string
      if (_isString(base)) {
        base = url.parse(base || '');
      }

      // parse given IRI
      var rel = url.parse(iri);

      // per RFC3986 5.2.2
      var transform = {
        protocol: base.protocol || ''
      };

      if (rel.authority !== null) {
        transform.authority = rel.authority;
        transform.path = rel.path;
        transform.query = rel.query;
      } else {
        transform.authority = base.authority;

        if (rel.path === '') {
          transform.path = base.path;
          if (rel.query !== null) {
            transform.query = rel.query;
          } else {
            transform.query = base.query;
          }
        } else {
          if (rel.path.indexOf('/') === 0) {
            // IRI represents an absolute path
            transform.path = rel.path;
          } else {
            // merge paths
            var path = base.path;

            // append relative path to the end of the last directory from base
            if (rel.path !== '') {
              path = path.substr(0, path.lastIndexOf('/') + 1);
              if (path.length > 0 && path.substr(-1) !== '/') {
                path += '/';
              }
              path += rel.path;
            }

            transform.path = path;
          }
          transform.query = rel.query;
        }
      }

      // remove slashes and dots in path
      transform.path = _removeDotSegments(transform.path, !!transform.authority);

      // construct URL
      var rval = transform.protocol;
      if (transform.authority !== null) {
        rval += '//' + transform.authority;
      }
      rval += transform.path;
      if (transform.query !== null) {
        rval += '?' + transform.query;
      }
      if (rel.fragment !== null) {
        rval += '#' + rel.fragment;
      }

      // handle empty base
      if (rval === '') {
        rval = './';
      }

      return rval;
    }
