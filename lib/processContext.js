import {_retrieveContextUrls} from './_retrieveContextUrls';
import {_clone} from './_clone';
import {_isObject} from './_isObject';
import {_getInitialContext} from './_getInitialContext';
import {Processor} from './Processor';
import {documentLoader} from './documentLoader';
export const processContext = function(activeCtx, localCtx) {
      // get arguments
      var options = {};
      var callbackArg = 2;
      if (arguments.length > 3) {
        options = arguments[2] || {};
        callbackArg += 1;
      }
      var callback = arguments[callbackArg];

      // set default options
      if (!('base' in options)) {
        options.base = '';
      }
      if (!('documentLoader' in options)) {
        options.documentLoader = documentLoader;
      }

      // return initial context early for null context
      if (localCtx === null) {
        return callback(null, _getInitialContext(options));
      }

      // retrieve URLs in localCtx
      localCtx = _clone(localCtx);
      if (!(_isObject(localCtx) && '@context' in localCtx)) {
        localCtx = {
          '@context': localCtx
        };
      }
      _retrieveContextUrls(localCtx, options, function(err, ctx) {
        if (err) {
          return callback(err);
        }
        try {
          // process context
          ctx = new Processor().processContext(activeCtx, ctx, options);
        } catch (ex) {
          return callback(ex);
        }
        callback(null, ctx);
      });
    };
